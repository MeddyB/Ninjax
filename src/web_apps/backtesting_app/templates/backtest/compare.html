{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-balance-scale me-2"></i>Backtest Comparison</h1>
            <a href="{{ url_for('backtest_list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to List
            </a>
        </div>
    </div>
</div>

<!-- Comparison Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Comparison Summary</h6>
            </div>
            <div class="card-body">
                <p class="mb-0">Comparing {{ comparison_data|length }} backtests:</p>
                <ul class="list-inline mt-2 mb-0">
                    {% for backtest in comparison_data %}
                        <li class="list-inline-item">
                            <span class="badge bg-primary">{{ backtest.name }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Performance Comparison Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-table me-2"></i>Performance Metrics Comparison</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                {% for backtest in comparison_data %}
                                    <th class="text-center">{{ backtest.name }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Strategy</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="badge bg-secondary">{{ backtest.strategy }}</span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Market Pair</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">{{ backtest.pair }}</td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Period</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <small>{{ backtest.start_date }} to {{ backtest.end_date }}</small>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Total Return (%)</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="text-{{ 'success' if backtest.total_return > 0 else 'danger' }}">
                                            <strong>{{ backtest.total_return|round(2) }}%</strong>
                                        </span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Max Drawdown (%)</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="text-danger">{{ backtest.max_drawdown|round(2) }}%</span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Sharpe Ratio</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="text-{{ 'success' if backtest.sharpe_ratio > 1 else 'warning' if backtest.sharpe_ratio > 0 else 'danger' }}">
                                            {{ backtest.sharpe_ratio|round(3) }}
                                        </span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Sortino Ratio</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="text-{{ 'success' if backtest.sortino_ratio > 1 else 'warning' if backtest.sortino_ratio > 0 else 'danger' }}">
                                            {{ backtest.sortino_ratio|round(3) }}
                                        </span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Win Rate (%)</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="text-{{ 'success' if backtest.win_rate > 60 else 'warning' if backtest.win_rate > 40 else 'danger' }}">
                                            {{ backtest.win_rate|round(1) }}%
                                        </span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Profit Factor</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">
                                        <span class="text-{{ 'success' if backtest.profit_factor > 1.5 else 'warning' if backtest.profit_factor > 1 else 'danger' }}">
                                            {{ backtest.profit_factor|round(2) }}
                                        </span>
                                    </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Total Trades</strong></td>
                                {% for backtest in comparison_data %}
                                    <td class="text-center">{{ backtest.total_trades }}</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Equity Curves Comparison -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Equity Curves Comparison</h6>
            </div>
            <div class="card-body">
                <canvas id="comparisonChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Risk-Return Scatter Plot -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-scatter me-2"></i>Risk vs Return</h6>
            </div>
            <div class="card-body">
                <canvas id="riskReturnChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-ranking-star me-2"></i>Performance Ranking</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% set sorted_backtests = comparison_data|sort(attribute='total_return', reverse=true) %}
                    {% for backtest in sorted_backtests %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ backtest.name }}</h6>
                                <small class="text-muted">{{ backtest.strategy }} - {{ backtest.pair }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ 'success' if backtest.total_return > 0 else 'danger' }} fs-6">
                                    {{ backtest.total_return|round(2) }}%
                                </span>
                                <br>
                                <small class="text-muted">Sharpe: {{ backtest.sharpe_ratio|round(2) }}</small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load equity curves for all backtests
    const backtestIds = {{ comparison_data|map(attribute='id')|list|tojson }};
    const backtestNames = {{ comparison_data|map(attribute='name')|list|tojson }};
    
    Promise.all(backtestIds.map(id => 
        fetch(`/api/backtest/${id}/equity-curve`).then(r => r.json())
    ))
    .then(equityDataArray => {
        renderComparisonChart(equityDataArray, backtestNames);
        renderRiskReturnChart();
    })
    .catch(error => {
        console.error('Error loading comparison data:', error);
    });
});

function renderComparisonChart(equityDataArray, names) {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    const colors = [
        '#0d6efd', '#198754', '#dc3545', '#fd7e14', 
        '#6f42c1', '#d63384', '#20c997', '#ffc107'
    ];
    
    const datasets = equityDataArray.map((equityData, index) => ({
        label: names[index],
        data: equityData.equity_curve.map(point => ({
            x: point.date,
            y: point.value
        })),
        borderColor: colors[index % colors.length],
        backgroundColor: colors[index % colors.length] + '20',
        tension: 0.1,
        fill: false,
        pointRadius: 0
    }));
    
    new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        parser: 'YYYY-MM-DD',
                        displayFormats: {
                            day: 'MMM DD'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function renderRiskReturnChart() {
    const ctx = document.getElementById('riskReturnChart').getContext('2d');
    
    const comparisonData = {{ comparison_data|tojson }};
    const colors = [
        '#0d6efd', '#198754', '#dc3545', '#fd7e14', 
        '#6f42c1', '#d63384', '#20c997', '#ffc107'
    ];
    
    const datasets = [{
        label: 'Backtests',
        data: comparisonData.map((backtest, index) => ({
            x: Math.abs(backtest.max_drawdown),
            y: backtest.total_return,
            label: backtest.name,
            backgroundColor: colors[index % colors.length],
            borderColor: colors[index % colors.length]
        })),
        backgroundColor: function(context) {
            return context.parsed ? context.raw.backgroundColor : '#0d6efd';
        },
        borderColor: function(context) {
            return context.parsed ? context.raw.borderColor : '#0d6efd';
        },
        pointRadius: 8,
        pointHoverRadius: 10
    }];
    
    new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Max Drawdown (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Total Return (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return `${point.label}: Return ${context.parsed.y.toFixed(1)}%, Drawdown ${context.parsed.x.toFixed(1)}%`;
                        }
                    }
                },
                legend: {
                    display: false
                }
            }
        }
    });
}
</script>
{% endblock %}