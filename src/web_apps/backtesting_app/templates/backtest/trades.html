{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-list me-2"></i>Trades - {{ results.name }}</h1>
            <div>
                <a href="{{ url_for('backtest_results', backtest_id=backtest_id) }}" class="btn btn-info me-2">
                    <i class="fas fa-chart-area me-1"></i>Results Overview
                </a>
                <a href="{{ url_for('backtest_performance', backtest_id=backtest_id) }}" class="btn btn-warning me-2">
                    <i class="fas fa-analytics me-1"></i>Performance Analysis
                </a>
                <a href="{{ url_for('backtest_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Trade Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-primary">{{ total_trades }}</h4>
                <p class="mb-0">Total Trades</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-success">{{ results.winning_trades }}</h4>
                <p class="mb-0">Winning Trades</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-danger">{{ results.losing_trades }}</h4>
                <p class="mb-0">Losing Trades</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-{{ 'success' if results.win_rate > 50 else 'danger' }}">
                    {{ results.win_rate|round(1) }}%
                </h4>
                <p class="mb-0">Win Rate</p>
            </div>
        </div>
    </div>
</div>

<!-- Trades Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-table me-2"></i>Trade History</h6>
                <div>
                    <small class="text-muted">
                        Showing {{ trades|length }} of {{ total_trades }} trades
                        {% if current_page > 1 or current_page < total_pages %}
                            (Page {{ current_page }} of {{ total_pages }})
                        {% endif %}
                    </small>
                </div>
            </div>
            <div class="card-body">
                {% if trades %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Timestamp</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                    <th>P&L</th>
                                    <th>Cumulative P&L</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set cumulative_pnl = 0 %}
                                {% for trade in trades %}
                                    {% set cumulative_pnl = cumulative_pnl + trade.pnl %}
                                    <tr>
                                        <td>{{ loop.index + (current_page - 1) * 50 }}</td>
                                        <td>
                                            <small>{{ trade.timestamp }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if trade.type == 'buy' else 'danger' }}">
                                                {{ trade.type|upper }}
                                            </span>
                                        </td>
                                        <td>${{ "{:,.4f}".format(trade.price) }}</td>
                                        <td>{{ trade.quantity }}</td>
                                        <td>${{ "{:,.2f}".format(trade.price * trade.quantity) }}</td>
                                        <td>
                                            {% if trade.pnl != 0 %}
                                                <span class="text-{{ 'success' if trade.pnl > 0 else 'danger' }}">
                                                    ${{ "{:,.2f}".format(trade.pnl) }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-{{ 'success' if cumulative_pnl > 0 else 'danger' if cumulative_pnl < 0 else 'muted' }}">
                                                ${{ "{:,.2f}".format(cumulative_pnl) }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if trade.pnl > 0 %}
                                                <i class="fas fa-arrow-up text-success" title="Profitable"></i>
                                            {% elif trade.pnl < 0 %}
                                                <i class="fas fa-arrow-down text-danger" title="Loss"></i>
                                            {% else %}
                                                <i class="fas fa-minus text-muted" title="Neutral"></i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if total_pages > 1 %}
                        <nav aria-label="Trades pagination" class="mt-3">
                            <ul class="pagination justify-content-center">
                                {% if current_page > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('backtest_trades', backtest_id=backtest_id, page=current_page-1) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in range(1, total_pages + 1) %}
                                    {% if page_num == current_page %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('backtest_trades', backtest_id=backtest_id, page=page_num) }}">
                                                {{ page_num }}
                                            </a>
                                        </li>
                                    {% elif page_num == 4 or page_num == total_pages - 3 %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if current_page < total_pages %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('backtest_trades', backtest_id=backtest_id, page=current_page+1) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                    
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No trades found</h5>
                        <p class="text-muted">This backtest has no trade data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips for status icons
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add row click handlers for trade details
    const tradeRows = document.querySelectorAll('tbody tr');
    tradeRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function() {
            // Could expand to show trade details
            console.log('Trade row clicked');
        });
    });
});
</script>
{% endblock %}