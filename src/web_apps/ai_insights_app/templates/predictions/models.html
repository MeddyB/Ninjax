{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-cogs me-2"></i>AI Models Management</h1>
            <div class="btn-group" role="group">
                <a href="{{ url_for('predictions_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Predictions
                </a>
                <button type="button" class="btn btn-outline-primary" onclick="refreshModels()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Models Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>AI Models Status
                </h5>
            </div>
            <div class="card-body">
                {% if models_status and models_status.models %}
                    <div class="row">
                        {% for model in models_status.models %}
                            <div class="col-md-4 mb-4">
                                <div class="card border-{{ 'success' if model.status == 'ready' else 'warning' if model.status == 'training' else 'secondary' }} h-100" data-model-id="{{ loop.index0 }}">
                                    <div class="card-header bg-{{ 'success' if model.status == 'ready' else 'warning' if model.status == 'training' else 'secondary' }} text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">{{ model.name }}</h6>
                                            <span class="badge bg-light text-dark">{{ model.type }}</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <i class="fas fa-{{ 'brain' if model.type == 'LLM' else 'chart-line' if model.type == 'ML' else 'eye' }} fa-3x text-{{ 'success' if model.status == 'ready' else 'warning' if model.status == 'training' else 'secondary' }}"></i>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small text-muted">Status</span>
                                                <span class="badge bg-{{ 'success' if model.status == 'ready' else 'warning' if model.status == 'training' else 'secondary' }}">
                                                    {{ model.status|title }}
                                                </span>
                                            </div>
                                            
                                            {% if model.accuracy %}
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="small text-muted">Accuracy</span>
                                                    <span class="fw-bold text-{{ 'success' if model.accuracy > 80 else 'warning' if model.accuracy > 70 else 'danger' }}">
                                                        {{ model.accuracy }}%
                                                    </span>
                                                </div>
                                                <div class="progress mb-2" style="height: 6px;">
                                                    <div class="progress-bar bg-{{ 'success' if model.accuracy > 80 else 'warning' if model.accuracy > 70 else 'danger' }}" 
                                                         style="width: {{ model.accuracy }}%"></div>
                                                </div>
                                            {% endif %}
                                            
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="small text-muted">Last Update</span>
                                                <span class="small">{{ moment(model.last_update).fromNow() if moment else model.last_update }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewModelDetails('{{ loop.index0 }}')">
                                                <i class="fas fa-eye me-1"></i>Details
                                            </button>
                                            {% if model.status == 'ready' %}
                                                <button class="btn btn-sm btn-warning" onclick="retrainModel('{{ loop.index0 }}')" data-model-id="{{ loop.index0 }}">
                                                    <i class="fas fa-redo me-1"></i>Retrain
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <h5>No AI Models Available</h5>
                        <p class="mb-0">AI models are currently being initialized. Please check back in a few minutes.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Model Performance Metrics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Model Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                {% if model_metrics %}
                    <div class="row">
                        {% for model_name, metrics in model_metrics.items() %}
                            <div class="col-md-4 mb-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ model_name.replace('_', ' ').title() }}</h6>
                                        
                                        <div class="row text-center mb-3">
                                            <div class="col-6">
                                                <div class="fw-bold text-success">{{ "%.1f"|format(metrics.accuracy * 100) }}%</div>
                                                <small class="text-muted">Accuracy</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="fw-bold text-info">{{ "%.1f"|format(metrics.f1_score * 100) }}%</div>
                                                <small class="text-muted">F1 Score</small>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">Precision</small>
                                                <small class="fw-bold">{{ "%.1f"|format(metrics.precision * 100) }}%</small>
                                            </div>
                                            <div class="progress mb-1" style="height: 4px;">
                                                <div class="progress-bar bg-primary" style="width: {{ metrics.precision * 100 }}%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">Recall</small>
                                                <small class="fw-bold">{{ "%.1f"|format(metrics.recall * 100) }}%</small>
                                            </div>
                                            <div class="progress mb-1" style="height: 4px;">
                                                <div class="progress-bar bg-success" style="width: {{ metrics.recall * 100 }}%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <small class="text-muted d-block">Training Samples: {{ "{:,}".format(metrics.training_samples) }}</small>
                                            <small class="text-muted d-block">Validation Loss: {{ "%.3f"|format(metrics.validation_loss) }}</small>
                                            <small class="text-muted">Last Training: {{ moment(metrics.last_training).fromNow() if moment else metrics.last_training }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Model performance metrics are being calculated. Please check back shortly.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Model Configuration -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sliders-h me-2"></i>Model Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="modelConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionInterval" class="form-label">Prediction Update Interval</label>
                                <select class="form-select" id="predictionInterval">
                                    <option value="5">5 minutes</option>
                                    <option value="15" selected>15 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="confidenceThreshold" class="form-label">Minimum Confidence Threshold</label>
                                <input type="range" class="form-range" id="confidenceThreshold" min="0" max="100" value="70">
                                <div class="d-flex justify-content-between">
                                    <small>0%</small>
                                    <small id="confidenceValue">70%</small>
                                    <small>100%</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="retrainingSchedule" class="form-label">Auto-Retraining Schedule</label>
                                <select class="form-select" id="retrainingSchedule">
                                    <option value="daily">Daily</option>
                                    <option value="weekly" selected>Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="manual">Manual Only</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Enabled Models</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enablePricePrediction" checked>
                                    <label class="form-check-label" for="enablePricePrediction">
                                        Price Prediction Model
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableSentimentAnalysis" checked>
                                    <label class="form-check-label" for="enableSentimentAnalysis">
                                        Sentiment Analysis Model
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableVolatilityPrediction" checked>
                                    <label class="form-check-label" for="enableVolatilityPrediction">
                                        Volatility Prediction Model
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary" onclick="resetConfiguration()">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>Model Management Tools
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="retrainAllModels()">
                        <i class="fas fa-redo me-1"></i>Retrain All Models
                    </button>
                    <button class="btn btn-info" onclick="exportModelMetrics()">
                        <i class="fas fa-download me-1"></i>Export Metrics
                    </button>
                    <button class="btn btn-warning" onclick="optimizeModels()">
                        <i class="fas fa-magic me-1"></i>Optimize Models
                    </button>
                    <button class="btn btn-success" onclick="backupModels()">
                        <i class="fas fa-save me-1"></i>Backup Models
                    </button>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>
                        <strong>Tip:</strong> Regular retraining improves model accuracy. 
                        Consider enabling auto-retraining for optimal performance.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modelDetailsTitle">Model Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modelDetailsContent">
                <!-- Model details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="retrainModelBtn">Retrain Model</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Update confidence threshold display
document.getElementById('confidenceThreshold').addEventListener('input', function(e) {
    document.getElementById('confidenceValue').textContent = e.target.value + '%';
});

// Model configuration form
document.getElementById('modelConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveModelConfiguration();
});

function refreshModels() {
    location.reload();
}

function viewModelDetails(modelIndex) {
    // Update modal title
    document.getElementById('modelDetailsTitle').textContent = `Model Details - ${modelIndex}`;
    
    // Show loading state
    const modalContent = document.getElementById('modelDetailsContent');
    modalContent.innerHTML = AIInsightsApp.createLoadingHTML('Loading model details...');
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
    modal.show();
    
    // Simulate API call to get model details
    setTimeout(() => {
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Model Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Model Type:</strong></td><td>LSTM Neural Network</td></tr>
                        <tr><td><strong>Version:</strong></td><td>2.1.0</td></tr>
                        <tr><td><strong>Architecture:</strong></td><td>Multi-layer LSTM with attention</td></tr>
                        <tr><td><strong>Input Features:</strong></td><td>128</td></tr>
                        <tr><td><strong>Output Classes:</strong></td><td>3 (Buy/Hold/Sell)</td></tr>
                        <tr><td><strong>Training Data:</strong></td><td>50,000 samples</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Performance Metrics</h6>
                    <canvas id="modelPerformanceChart" height="200"></canvas>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Training History</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Accuracy</th>
                                    <th>Loss</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-08-10</td>
                                    <td>85.2%</td>
                                    <td>0.023</td>
                                    <td>2h 15m</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                </tr>
                                <tr>
                                    <td>2024-08-03</td>
                                    <td>83.7%</td>
                                    <td>0.028</td>
                                    <td>2h 8m</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                </tr>
                                <tr>
                                    <td>2024-07-27</td>
                                    <td>82.1%</td>
                                    <td>0.031</td>
                                    <td>1h 55m</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Create performance chart
        const ctx = document.getElementById('modelPerformanceChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score', 'Speed'],
                datasets: [{
                    label: 'Current Model',
                    data: [85, 87, 83, 85, 92],
                    borderColor: '#007bff',
                    backgroundColor: '#007bff20',
                    pointBackgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
        
        // Update retrain button
        const retrainBtn = document.getElementById('retrainModelBtn');
        retrainBtn.onclick = () => retrainModel(modelIndex);
    }, 1500);
}

function retrainModel(modelIndex) {
    if (!confirm('Are you sure you want to retrain this model? This process may take several hours.')) {
        return;
    }
    
    const button = document.querySelector(`[data-model-id="${modelIndex}"]`);
    if (button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Retraining...';
        button.disabled = true;
        
        // Simulate retraining process
        setTimeout(() => {
            AIInsightsApp.showNotification('Model retraining started successfully', 'success');
            button.innerHTML = originalText;
            button.disabled = false;
            
            // Update model status to training
            const modelCard = button.closest('.card');
            const statusBadge = modelCard.querySelector('.badge');
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = 'Training';
        }, 2000);
    }
    
    // Close modal if open
    const modal = bootstrap.Modal.getInstance(document.getElementById('modelDetailsModal'));
    if (modal) modal.hide();
}

function saveModelConfiguration() {
    const config = {
        predictionInterval: document.getElementById('predictionInterval').value,
        confidenceThreshold: document.getElementById('confidenceThreshold').value / 100,
        retrainingSchedule: document.getElementById('retrainingSchedule').value,
        enabledModels: {
            pricePrediction: document.getElementById('enablePricePrediction').checked,
            sentimentAnalysis: document.getElementById('enableSentimentAnalysis').checked,
            volatilityPrediction: document.getElementById('enableVolatilityPrediction').checked
        }
    };
    
    // Save configuration (simulate API call)
    AIInsightsApp.showNotification('Saving model configuration...', 'info');
    
    setTimeout(() => {
        AIInsightsApp.showNotification('Model configuration saved successfully', 'success');
    }, 1000);
}

function resetConfiguration() {
    document.getElementById('predictionInterval').value = '15';
    document.getElementById('confidenceThreshold').value = '70';
    document.getElementById('confidenceValue').textContent = '70%';
    document.getElementById('retrainingSchedule').value = 'weekly';
    document.getElementById('enablePricePrediction').checked = true;
    document.getElementById('enableSentimentAnalysis').checked = true;
    document.getElementById('enableVolatilityPrediction').checked = true;
    
    AIInsightsApp.showNotification('Configuration reset to defaults', 'info');
}

function retrainAllModels() {
    if (!confirm('Are you sure you want to retrain all models? This process may take several hours and will temporarily reduce prediction accuracy.')) {
        return;
    }
    
    AIInsightsApp.showNotification('Starting retraining for all models...', 'info');
    
    // Update all model statuses to training
    document.querySelectorAll('[data-model-id]').forEach(button => {
        const modelCard = button.closest('.card');
        const statusBadge = modelCard.querySelector('.badge');
        statusBadge.className = 'badge bg-warning';
        statusBadge.textContent = 'Training';
        button.disabled = true;
    });
}

function exportModelMetrics() {
    AIInsightsApp.showNotification('Exporting model metrics...', 'info');
    setTimeout(() => {
        AIInsightsApp.showNotification('Model metrics exported successfully', 'success');
    }, 2000);
}

function optimizeModels() {
    AIInsightsApp.showNotification('Starting model optimization...', 'info');
    setTimeout(() => {
        AIInsightsApp.showNotification('Model optimization completed', 'success');
    }, 3000);
}

function backupModels() {
    AIInsightsApp.showNotification('Creating model backup...', 'info');
    setTimeout(() => {
        AIInsightsApp.showNotification('Model backup created successfully', 'success');
    }, 2000);
}

// Load saved configuration
document.addEventListener('DOMContentLoaded', function() {
    // Load any saved configuration from localStorage or API
    console.log('Model management page loaded');
});
</script>
{% endblock %}